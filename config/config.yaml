# Therasync Pipeline Configuration
# Configuration for physiological data preprocessing and analysis

# Study Configuration
study:
  name: "therasync"
  version: "1.0.0"
  description: "Family therapy session physiological analysis"

# Data paths and BIDS structure
paths:
  rawdata: "data/raw"
  derivatives: "data/derivatives"
  logs: "log"

# Output structure for preprocessing derivatives
output:
  # Base directory structure: derivatives/preprocessing/sub-xxx/ses-yyy/{modality}/
  preprocessing_dir: "preprocessing"  # derivatives/preprocessing/
  modality_subdirs:
    bvp: "bvp"     # derivatives/preprocessing/sub-xxx/ses-yyy/bvp/
    eda: "eda"     # derivatives/preprocessing/sub-xxx/ses-yyy/eda/
    hr: "hr"       # derivatives/preprocessing/sub-xxx/ses-yyy/hr/
  
# Moment/Task definitions - flexible for different study designs
moments:
  # Current study has 2 moments
  - name: "restingstate"
    description: "Baseline resting state recording (~1 minute)"
    duration_expected: 60  # seconds, approximate
  - name: "therapy"
    description: "Therapeutic session recording (40-120 minutes)"
    duration_expected: 3600  # seconds, approximate
  
  # Example for future 5-moment study:
  # - name: "baseline"
  # - name: "task1"
  # - name: "break"
  # - name: "task2"
  # - name: "recovery"

# Physiological data processing parameters
physio:
  # BVP (Blood Volume Pulse) processing
  bvp:
    sampling_rate: 64  # Hz, from Empatica E4
    processing:
      method: "elgendi"  # Peak detection method for nk.ppg_process
      method_quality: "templatematch"  # Quality assessment method
      lowcut_freq: 0.5   # Hz - for additional filtering if needed
      highcut_freq: 8.0  # Hz - for additional filtering if needed
      quality_threshold: 0.8  # Minimum quality for accepting peaks (0-1 scale)
                              # Note: Longer recordings (>30 min) often have lower scores (0.65-0.75) but remain usable
    
    # RR Intervals extraction configuration
    rr_intervals:
      enabled: true           # Extract and save RR intervals to file
      min_valid_ms: 300       # Minimum valid RR interval (ms) - corresponds to ~200 BPM max
      max_valid_ms: 2000      # Maximum valid RR interval (ms) - corresponds to ~30 BPM min
                              # Values outside this range are marked as invalid (not removed)
      save_all: true          # Save all RR intervals, including invalid ones (marked with is_valid=0)
    
    metrics:
      extract_all: false
      selected_metrics:
        # Essential Set - Time Domain (5 metrics)
        time_domain:
          - "HRV_MeanNN"     # Average heart rate
          - "HRV_SDNN"       # Overall HRV
          - "HRV_RMSSD"      # Parasympathetic activity
          - "HRV_pNN50"      # Parasympathetic activity
          - "HRV_CVNN"       # Normalized variability
        # Essential Set - Frequency Domain (4 metrics)  
        frequency_domain:
          - "HRV_LF"         # Sympathetic + parasympathetic
          - "HRV_HF"         # Parasympathetic (RSA)
          - "HRV_LFHF"       # Autonomic balance
          - "HRV_TP"         # Total power
        # Essential Set - Non-Linear (3 metrics)
        nonlinear:
          - "HRV_SD1"        # Short-term variability
          - "HRV_SD2"        # Long-term variability
          - "HRV_SampEn"     # Signal complexity
      # Future: Epoched analysis configuration
      epoched_analysis:
        enabled: false       # For future Sprint implementation
        window_size: 30      # seconds
        step_size: 1         # seconds
  
  # EDA (Electrodermal Activity) processing
  eda:
    sampling_rate: 4  # Hz, from Empatica E4
    processing:
      method: "neurokit"  # EDA processing method (neurokit default)
      method_scr: "neurokit"  # SCR peak detection method
      lowcut_freq: 0.05   # Hz - high-pass filter for baseline drift
      highcut_freq: 1.0   # Hz - low-pass filter for noise
      scr_threshold: 0.01  # Minimum SCR amplitude (μS)
      scr_min_amplitude: 0.01  # Minimum amplitude for valid SCR (μS)
    metrics:
      extract_all: false
      selected_metrics:
        # SCR (Skin Conductance Response) metrics
        scr:
          - "SCR_Peaks_N"        # Number of SCR peaks
          - "SCR_Peaks_Amplitude_Mean"  # Mean SCR amplitude
          - "SCR_Peaks_Amplitude_Max"   # Maximum SCR amplitude
          - "SCR_RiseTime_Mean"   # Mean rise time (seconds)
          - "SCR_RecoveryTime_Mean"  # Mean recovery time (seconds)
        # Tonic/Phasic components
        components:
          - "EDA_Tonic_Mean"     # Mean tonic level (μS)
          - "EDA_Tonic_SD"       # Tonic level variability
          - "EDA_Phasic_Mean"    # Mean phasic activity
          - "EDA_Phasic_SD"      # Phasic variability
          - "EDA_Phasic_Rate"    # Rate of phasic responses (per minute)
        min_peaks_per_epoch: 20  # minimum beats for valid HRV
    
  # EDA (Electrodermal Activity) processing  
  eda:
    sampling_rate: 4   # Hz, from Empatica E4
    cleaning:
      method: "neurokit"  # Method to be selected during decision phase
      parameters:
        # Parameters will be added after method selection
    metrics:
      # Metrics list will be populated after decision phase
      extract_all: false
      selected_metrics: []
  
  # HR (Heart Rate) processing
  hr:
    source: "bvp"  # Derived from BVP signal
    processing:
      method: "neurokit"  # Method to be selected during decision phase (e.g., template_matching)
      parameters:
        # Parameters will be added after method selection
    metrics:
      # Metrics list will be populated after decision phase
      extract_all: false
      selected_metrics: []

# BIDS output configuration
bids:
  # Naming conventions following BIDS specification
  subject_prefix: "sub-"
  session_prefix: "ses-"
  task_prefix: "task-"
  
  # Metadata that will be included in JSON sidecars
  metadata:
    include_acquisition_time: true
    include_sampling_rate: true
    include_processing_parameters: true
    include_quality_metrics: true

# Processing options
processing:
  # Parallel processing
  n_jobs: 1  # Number of parallel jobs (-1 for all cores)
  
  # Quality control
  quality_check: true
  min_signal_duration: 30  # seconds, minimum duration for valid processing
  
  # Output options
  save_intermediate: false  # Save intermediate processing steps
  save_plots: true         # Save diagnostic plots
  
# Logging configuration
logging:
  level: "INFO"  # DEBUG, INFO, WARNING, ERROR, CRITICAL
  format: "%(asctime)s - %(name)s - %(levelname)s - %(message)s"
  file_rotation: true
  max_file_size: "10MB"
  backup_count: 5

# Epoching configuration
# Used to segment physiological signals into time windows for analysis
epoching:
  enabled: true
  
  # Epoching methods
  methods:
    # Method 1: Fixed window with overlap
    # Creates epochs of fixed duration with specified overlap
    # Example: duration=30s, overlap=5s → epochs every 25s (step=duration-overlap)
    fixed:
      enabled: true
      duration: 30        # seconds - epoch duration
      overlap: 5          # seconds - overlap between consecutive epochs
      min_duration_ratio: 0.0  # Keep all partial epochs (0.0=all, 1.0=only complete)
    
    # Method 2: N-split
    # Divides signal into exactly N epochs of equal duration
    # Useful for epoch shuffling (ensures same number of epochs per session)
    nsplit:
      enabled: true
      n_epochs: 120       # Number of epochs (~30s each for 1h sessions)
    
    # Method 3: Sliding window
    # Creates overlapping epochs with small step size
    # Useful for Dyadic Poincaré Plot Analysis (DPPA)
    sliding:
      enabled: true
      duration: 30        # seconds - epoch duration
      step: 5             # seconds - step between consecutive epochs
      min_duration_ratio: 0.0  # Keep all partial epochs
  
  # Files to epoch (glob patterns)
  include:
    - "*_desc-processed_recording-*.tsv"  # All processed signal files
    - "*_desc-rrintervals_physio.tsv"     # RR intervals files
  
  # Files to exclude (glob patterns)
  exclude:
    - "*_desc-*-metrics_*.tsv"            # Metrics files (not epochable)
    - "*_desc-*-summary_*.json"           # Summary files
    - "*_events.tsv"                      # Event files
  
  # Output configuration
  output:
    base_dir: "epoched"  # derivatives/epoched/
    # Structure: derivatives/epoched/sub-xxx/ses-yyy/{modality}/
    # Note: task-restingstate files always get epoch_id=0 for all methods
    #       task-therapy files get proper epoch assignments based on methods